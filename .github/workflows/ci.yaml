name: integrator_frontend
on:
  pull_request:
    types:
      - closed
    branches:
      - master
  push:
    branches:
      - master
jobs:
  build-and-deploy:
    if: github.event.pull_request.merged == true || github.event_name == 'push'
    runs-on: integrator_frontend
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
      - name: Cache npm dependencies
        id: cache-npm
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-
      - name: Install dependencies
        run: npm ci
      - name: Build
        run: npm run build
      - name: Debug build output
        run: |
          echo "Listing contents of current directory:"
          ls -la
          echo "Checking if dist directory exists:"
          ls -la dist/ || echo "dist directory not found"
          echo "Searching for index.html in all directories:"
          find . -name "index.html" -type f || echo "No index.html found"
          echo "Listing all directories that might contain build output:"
          find . -maxdepth 2 -type d -name "*build*" -o -name "*dist*" -o -name "*out*" -o -name "*public*" || echo "No common build directories found"
      - name: Deploy integrator frontend
        run: |
          # Set error handling
          set -e
          echo "Creating temporary directory..."
          TEMP_DIR="/tmp/integrator_frontend-$(date +%s)"
          mkdir -p $TEMP_DIR
          echo "Copying built files to temporary location..."
          cp -r dist/* $TEMP_DIR/    # Changed from dist/app/* to dist/*
          echo "Verifying index.html exists in temporary directory..."
          if [ ! -f "$TEMP_DIR/index.html" ]; then
            echo "Error: index.html not found in build output!"
            exit 1
          fi
          echo "Setting proper permissions..."
          sudo chown -R www-data:www-data $TEMP_DIR
          sudo chmod -R 755 $TEMP_DIR
          echo "Performing atomic deployment swap..."
          sudo -s <<EOF
          # Backup existing deployment if it exists
          if [ -d "/var/www/integrator_frontend" ]; then
            mv /var/www/integrator_frontend "/var/www/integrator_frontend-backup-$(date +%s)"
          fi
          # Move new deployment into place
          mv $TEMP_DIR /var/www/integrator_frontend
          # Clean up old backups (keep last 2)
          cd /var/www && ls -td integrator_frontend-backup-* | tail -n +3 | xargs -r rm -rf
          EOF
          echo "Verifying deployment..."
          if [ ! -d "/var/www/integrator_frontend" ]; then
            echo "Deployment directory does not exist!"
            exit 1
          fi
          if [ ! -f "/var/www/integrator_frontend/index.html" ]; then
            echo "index.html not found in deployment directory!"
            exit 1
          fi
          echo "Testing file permissions..."
          if ! sudo -u www-data test -r /var/www/integrator_frontend/index.html; then
            echo "Permission test failed!"
            exit 1
          fi
          echo "Deployment completed successfully at $(date)"
      - name: Cleanup
        if: always()
        run: |
          # Clean up temporary files if they exist
          rm -rf /tmp/integrator_frontend-*