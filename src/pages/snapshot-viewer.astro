---
import Layout from '../layouts/Layout.astro';

// Get snapshot ID from URL
const url = new URL(Astro.request.url);
const snapshotId = url.searchParams.get('id');
---

<Layout title="Snapshot Viewer">
  <div id="snapshot-container">
    {!snapshotId ? (
      <div class="error-container">No snapshot ID provided</div>
    ) : (
      <div class="loading-container">Loading snapshot...</div>
    )}
  </div>
  <div id="snapshot-editor" style="width: 100vw; height: 100vh; display: none;"></div>

  <style>
    .error-container {
      padding: 20px;
      color: red;
      font-family: Arial, sans-serif;
    }
    .loading-container {
      padding: 20px;
      font-family: Arial, sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
  </style>

  <script define:vars={{ snapshotId }}>
    if (snapshotId) {
      // Fetch snapshot data
      fetch(`/api/snapshots/${snapshotId}`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.success) {
            const snapshot = data.data;
            let content = snapshot.content || '';
            let language = 'text';
            
            // Try to format as JSON
            try {
              const jsonContent = JSON.parse(content);
              content = JSON.stringify(jsonContent, null, 2);
              language = 'json';
            } catch (error) {
              // Content is not JSON, use as text
            }
            
            // Hide loading container and show editor
            document.getElementById('snapshot-container').style.display = 'none';
            document.getElementById('snapshot-editor').style.display = 'block';
            
            // Create Monaco editor
            require(['vs/editor/editor.main'], function() {
              const editor = monaco.editor.create(document.getElementById('snapshot-editor'), {
                value: content,
                language: language,
                theme: 'vs',
                readOnly: true,
                minimap: { enabled: true },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                fontSize: 14,
                lineNumbers: 'on',
                wordWrap: 'on',
                renderWhitespace: 'selection',
                contextmenu: true
              });
              
              // Handle window resize
              window.addEventListener('resize', () => {
                editor.layout();
              });
            });
          } else {
            document.getElementById('snapshot-container').innerHTML = 
              `<div class="error-container">Failed to load snapshot: ${data.error}</div>`;
          }
        })
        .catch(error => {
          document.getElementById('snapshot-container').innerHTML = 
            `<div class="error-container">Error loading snapshot: ${error.message}</div>`;
        });
    }
  </script>
</Layout>